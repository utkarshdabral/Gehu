<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Contest - Local Coding Contest Platform</title>
    <link rel="stylesheet" href="../css/main.css">
  <script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Flocalcodi4388back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.9"></script>
  <script type="module" src="https://static.rocket.new/rocket-shot.js?v=0.0.1"></script>
  </head>
<body class="bg-background min-h-screen font-sans">
    <!-- Navigation Header -->
    <nav class="bg-surface shadow-card border-b border-secondary-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <h1 class="text-xl font-semibold text-text-primary">Contest Platform</h1>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="contest_setup.html" class="text-text-secondary hover:text-primary transition-smooth px-3 py-2 rounded-lg hover:bg-secondary-100">Setup</a>
                    <a href="contest_management.html" class="text-text-secondary hover:text-primary transition-smooth px-3 py-2 rounded-lg hover:bg-secondary-100">Management</a>
                    <a href="participant_join.html" class="text-primary font-medium px-3 py-2 rounded-lg bg-primary-50">Join Contest</a>
                    <a href="submission_dashboard.html" class="text-text-secondary hover:text-primary transition-smooth px-3 py-2 rounded-lg hover:bg-secondary-100">Dashboard</a>
                    <a href="plagiarism_analysis.html" class="text-text-secondary hover:text-primary transition-smooth px-3 py-2 rounded-lg hover:bg-secondary-100">Analysis</a>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-btn" class="text-text-secondary hover:text-primary p-2">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-surface border-t border-secondary-200">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="contest_setup.html" class="block px-3 py-2 text-text-secondary hover:text-primary hover:bg-secondary-100 rounded-lg">Setup</a>
                <a href="contest_management.html" class="block px-3 py-2 text-text-secondary hover:text-primary hover:bg-secondary-100 rounded-lg">Management</a>
                <a href="participant_join.html" class="block px-3 py-2 text-primary font-medium bg-primary-50 rounded-lg">Join Contest</a>
                <a href="submission_dashboard.html" class="block px-3 py-2 text-text-secondary hover:text-primary hover:bg-secondary-100 rounded-lg">Dashboard</a>
                <a href="plagiarism_analysis.html" class="block px-3 py-2 text-text-secondary hover:text-primary hover:bg-secondary-100 rounded-lg">Analysis</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Connection Status Banner -->
        <div id="connection-banner" class="mb-6 hidden">
            <div class="bg-success-100 border border-success-500 rounded-lg p-4">
                <div class="flex items-center space-x-3">
                    <div class="status-dot connected"></div>
                    <div>
                        <p class="text-success font-medium">Connected to Contest</p>
                        <p class="text-success text-sm" id="connected-contest-name">Algorithm Challenge 2025</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Connection Methods -->
            <div class="space-y-6">
                <!-- Header -->
                <div class="text-center lg:text-left">
                    <h2 class="text-3xl font-semibold text-text-primary mb-2">Join Contest</h2>
                    <p class="text-text-secondary">Connect to a local coding contest using QR code or IP address</p>
                </div>

                <!-- QR Code Scanner -->
                <div class="bg-surface rounded-xl shadow-card border border-secondary-200">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-text-primary">QR Code Scanner</h3>
                            <button id="camera-toggle" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-700 transition-smooth">
                                <svg class="h-5 w-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Start Camera
                            </button>
                        </div>
                        
                        <div id="qr-scanner-container" class="relative">
                            <div id="camera-preview" class="hidden">
                                <video id="camera-video" class="w-full h-64 bg-secondary-100 rounded-lg object-cover" autoplay muted playsinline></video>
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <div class="w-48 h-48 border-2 border-primary rounded-lg"></div>
                                </div>
                                <canvas id="qr-canvas" class="hidden"></canvas>
                            </div>
                            
                            <div id="camera-placeholder" class="w-full h-64 bg-secondary-100 rounded-lg flex items-center justify-center">
                                <div class="text-center">
                                    <svg class="h-16 w-16 text-secondary-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 12h-4.01M12 12v4m6-4h.01M12 8h4.01M12 8h-4.01"/>
                                    </svg>
                                    <p class="text-text-secondary">Click "Start Camera" to scan QR code</p>
                                </div>
                            </div>
                        </div>

                        <div id="qr-status" class="mt-4 text-center text-sm text-text-secondary">
                            Position the QR code within the scanning area
                        </div>
                    </div>
                </div>

                <!-- Manual IP Entry -->
                <div class="bg-surface rounded-xl shadow-card border border-secondary-200">
                    <div class="p-6">
                        <h3 class="text-lg font-medium text-text-primary mb-4">Manual Connection</h3>
                        
                        <form id="manual-connect-form" class="space-y-4">
                            <div>
                                <label for="ip-address" class="block text-sm font-medium text-text-primary mb-2">IP Address & Port</label>
                                <input type="text" id="ip-address" name="ipAddress" 
                                       class="w-full px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-smooth"
                                       placeholder="192.168.1.100:8080">
                                <div class="text-error text-sm mt-1 hidden" id="ip-error">Please enter a valid IP address</div>
                            </div>
                            
                            <div>
                                <label for="invite-token" class="block text-sm font-medium text-text-primary mb-2">Invite Token (Optional)</label>
                                <input type="text" id="invite-token" name="inviteToken" maxlength="6"
                                       class="w-full px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-smooth text-center font-mono text-lg tracking-wider"
                                       placeholder="ABC123">
                            </div>
                            
                            <button type="submit" id="connect-btn" 
                                    class="w-full px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-700 transition-smooth">
                                Connect to Contest
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Connection Progress -->
                <div id="connection-progress" class="bg-surface rounded-xl shadow-card border border-secondary-200 hidden">
                    <div class="p-6">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="status-dot connecting"></div>
                            <h3 class="text-lg font-medium text-text-primary">Connecting...</h3>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Establishing connection</span>
                                <span id="progress-percentage" class="text-primary font-medium">0%</span>
                            </div>
                            <div class="w-full bg-secondary-200 rounded-full h-2">
                                <div id="progress-bar" class="progress-bar h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <div id="connection-steps" class="space-y-2 text-sm text-text-secondary">
                                <div id="step-1" class="flex items-center space-x-2">
                                    <div class="w-4 h-4 border-2 border-secondary-300 rounded-full"></div>
                                    <span>Contacting organizer...</span>
                                </div>
                                <div id="step-2" class="flex items-center space-x-2">
                                    <div class="w-4 h-4 border-2 border-secondary-300 rounded-full"></div>
                                    <span>Establishing WebRTC connection...</span>
                                </div>
                                <div id="step-3" class="flex items-center space-x-2">
                                    <div class="w-4 h-4 border-2 border-secondary-300 rounded-full"></div>
                                    <span>Downloading contest information...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Participant Information & Contest Details -->
            <div class="space-y-6">
                <!-- Display Name Form -->
                <div class="bg-surface rounded-xl shadow-card border border-secondary-200">
                    <div class="p-6">
                        <h3 class="text-lg font-medium text-text-primary mb-4">Participant Information</h3>
                        
                        <form id="participant-form" class="space-y-4">
                            <div>
                                <label for="display-name" class="block text-sm font-medium text-text-primary mb-2">Display Name *</label>
                                <input type="text" id="display-name" name="displayName" required maxlength="30"
                                       class="w-full px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-smooth"
                                       placeholder="Enter your name">
                                <div class="text-error text-sm mt-1 hidden" id="name-error">Display name is required</div>
                                <div class="text-text-secondary text-sm mt-1">
                                    <span id="name-counter">0</span>/30 characters
                                </div>
                            </div>
                            
                            <div>
                                <label for="participant-email" class="block text-sm font-medium text-text-primary mb-2">Email (Optional)</label>
                                <input type="email" id="participant-email" name="email"
                                       class="w-full px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-smooth"
                                       placeholder="your.email@example.com">
                            </div>
                            
                            <div>
                                <label for="team-name" class="block text-sm font-medium text-text-primary mb-2">Team Name (Optional)</label>
                                <input type="text" id="team-name" name="teamName" maxlength="50"
                                       class="w-full px-4 py-3 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-smooth"
                                       placeholder="Team Alpha">
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Contest Information (Hidden until connected) -->
                <div id="contest-info" class="bg-surface rounded-xl shadow-card border border-secondary-200 hidden">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-text-primary">Contest Information</h3>
                            <div class="status-dot connected"></div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-sm font-medium text-text-secondary uppercase tracking-wide">Title</h4>
                                <p id="contest-title" class="text-text-primary font-medium mt-1">Algorithm Challenge 2025</p>
                            </div>
                            
                            <div>
                                <h4 class="text-sm font-medium text-text-secondary uppercase tracking-wide">Description</h4>
                                <p id="contest-description" class="text-text-primary mt-1">Test your algorithmic skills with challenging problems covering data structures, dynamic programming, and graph algorithms.</p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <h4 class="text-sm font-medium text-text-secondary uppercase tracking-wide">Duration</h4>
                                    <p id="contest-duration" class="text-text-primary font-medium mt-1">2 hours</p>
                                </div>
                                <div>
                                    <h4 class="text-sm font-medium text-text-secondary uppercase tracking-wide">Time Remaining</h4>
                                    <p id="time-remaining" class="text-primary font-medium mt-1">1h 45m</p>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-sm font-medium text-text-secondary uppercase tracking-wide">Organizer</h4>
                                <div class="flex items-center space-x-3 mt-2">
                                    <img src="https://images.unsplash.com/photo-1652376924447-ab929125ee31" 
                                         alt="Contest organizer profile picture" class="w-8 h-8 rounded-full object-cover"
                                         onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                                    <div>
                                        <p class="text-text-primary font-medium">Dr. Sarah Chen</p>
                                        <p class="text-text-secondary text-sm">Computer Science Department</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pt-4 border-t border-secondary-200">
                                <button id="proceed-btn" class="w-full px-6 py-3 bg-accent text-white rounded-lg hover:bg-accent-600 transition-smooth">
                                    Proceed to Problems
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Troubleshooting Panel -->
                <div class="bg-surface rounded-xl shadow-card border border-secondary-200">
                    <div class="p-6">
                        <button id="troubleshoot-toggle" class="flex items-center justify-between w-full text-left">
                            <h3 class="text-lg font-medium text-text-primary">Connection Troubleshooting</h3>
                            <svg class="h-5 w-5 text-text-secondary transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        
                        <div id="troubleshoot-content" class="hidden mt-6 space-y-4">
                            <div class="text-sm text-text-secondary space-y-2">
                                <p><strong>Common Issues:</strong></p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li>Ensure you're connected to the same WiFi network as the organizer</li>
                                    <li>Check if the contest is still active and accepting participants</li>
                                    <li>Verify the IP address and port number are correct</li>
                                    <li>Try refreshing the page if connection fails</li>
                                </ul>
                            </div>
                            
                            <div class="border-t border-secondary-200 pt-4">
                                <h4 class="text-sm font-medium text-text-primary mb-3">Manual WebRTC Setup</h4>
                                <p class="text-sm text-text-secondary mb-3">For advanced users: If automatic connection fails, you can manually exchange WebRTC offers/answers.</p>
                                
                                <div class="space-y-3">
                                    <div>
                                        <label for="manual-offer" class="block text-xs font-medium text-text-secondary mb-1">Paste Offer from Organizer</label>
                                        <textarea id="manual-offer" rows="3" 
                                                  class="w-full px-3 py-2 text-xs border border-secondary-300 rounded font-mono"
                                                  placeholder="Paste WebRTC offer here..."></textarea>
                                    </div>
                                    
                                    <button id="process-offer-btn" class="w-full px-4 py-2 bg-secondary-600 text-white rounded text-sm hover:bg-secondary-700 transition-smooth">
                                        Process Offer & Generate Answer
                                    </button>
                                    
                                    <div id="manual-answer" class="hidden">
                                        <label class="block text-xs font-medium text-text-secondary mb-1">Your Answer (Send to Organizer)</label>
                                        <textarea id="answer-output" rows="3" readonly
                                                  class="w-full px-3 py-2 text-xs border border-secondary-300 rounded font-mono bg-secondary-50"></textarea>
                                        <button id="copy-answer-btn" class="mt-2 px-3 py-1 bg-primary text-white rounded text-xs hover:bg-primary-700 transition-smooth">
                                            Copy Answer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mobile menu toggle
        document.getElementById('mobile-menu-btn').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });

        // Troubleshooting toggle
        document.getElementById('troubleshoot-toggle').addEventListener('click', function() {
            const content = document.getElementById('troubleshoot-content');
            const icon = this.querySelector('svg');
            content.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        });

        // Display name character counter
        document.getElementById('display-name').addEventListener('input', function() {
            const counter = document.getElementById('name-counter');
            counter.textContent = this.value.length;
        });

        // Camera functionality
        let videoStream = null;
        let isScanning = false;

        document.getElementById('camera-toggle').addEventListener('click', async function() {
            const button = this;
            const preview = document.getElementById('camera-preview');
            const placeholder = document.getElementById('camera-placeholder');
            const video = document.getElementById('camera-video');
            const status = document.getElementById('qr-status');

            if (!isScanning) {
                try {
                    button.innerHTML = `
                        <svg class="h-5 w-5 inline mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Starting...
                    `;
                    button.disabled = true;

                    videoStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    video.srcObject = videoStream;
                    
                    placeholder.classList.add('hidden');
                    preview.classList.remove('hidden');
                    isScanning = true;
                    
                    button.innerHTML = `
                        <svg class="h-5 w-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                        </svg>
                        Stop Camera
                    `;
                    button.disabled = false;
                    status.textContent = 'Scanning for QR codes...';
                    
                    // Start QR code detection simulation
                    startQRDetection();
                    
                } catch (error) {
                    console.error('Camera access failed:', error);
                    status.textContent = 'Camera access denied or not available';
                    button.innerHTML = `
                        <svg class="h-5 w-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Start Camera
                    `;
                    button.disabled = false;
                }
            } else {
                stopCamera();
            }
        });

        function stopCamera() {
            const button = document.getElementById('camera-toggle');
            const preview = document.getElementById('camera-preview');
            const placeholder = document.getElementById('camera-placeholder');
            const status = document.getElementById('qr-status');

            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            preview.classList.add('hidden');
            placeholder.classList.remove('hidden');
            isScanning = false;
            
            button.innerHTML = `
                <svg class="h-5 w-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Start Camera
            `;
            status.textContent = 'Position the QR code within the scanning area';
        }

        function startQRDetection() {
            // Simulate QR code detection after 3 seconds
            setTimeout(() => {
                if (isScanning) {
                    const mockQRData = 'http://192.168.1.100:8080/join?token=ABC123';
                    handleQRCodeDetected(mockQRData);
                }
            }, 3000);
        }

        function handleQRCodeDetected(qrData) {
            const status = document.getElementById('qr-status');
            status.innerHTML = `
                <span class="text-success font-medium">
                    <svg class="h-4 w-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    QR Code detected! Connecting...
                </span>
            `;
            
            // Parse QR data and auto-fill form
            try {
                const url = new URL(qrData);
                const ip = url.host;
                const token = url.searchParams.get('token');
                
                document.getElementById('ip-address').value = ip;
                if (token) {
                    document.getElementById('invite-token').value = token;
                }
                
                // Auto-connect after 1 second
                setTimeout(() => {
                    simulateConnection();
                }, 1000);
                
            } catch (error) {
                console.error('Invalid QR code format:', error);
                status.textContent = 'Invalid QR code format';
            }
        }

        // Manual connection form
        document.getElementById('manual-connect-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const ipAddress = document.getElementById('ip-address').value.trim();
            const ipError = document.getElementById('ip-error');
            
            // Reset error state
            ipError.classList.add('hidden');
            
            // Basic IP validation
            if (!ipAddress) {
                ipError.textContent = 'Please enter an IP address';
                ipError.classList.remove('hidden');
                return;
            }
            
            if (!ipAddress.match(/^\d+\.\d+\.\d+\.\d+:\d+$/)) {
                ipError.textContent = 'Please enter a valid IP address and port (e.g., 192.168.1.100:8080)';
                ipError.classList.remove('hidden');
                return;
            }
            
            simulateConnection();
        });

        function simulateConnection() {
            const progressContainer = document.getElementById('connection-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            const steps = ['step-1', 'step-2', 'step-3'];
            
            // Show progress container
            progressContainer.classList.remove('hidden');
            
            // Stop camera if running
            if (isScanning) {
                stopCamera();
            }
            
            let progress = 0;
            let currentStep = 0;
            
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15 + 5; // Random progress increment
                
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(progressInterval);
                    
                    // Mark all steps as complete
                    steps.forEach(stepId => {
                        const step = document.getElementById(stepId);
                        const circle = step.querySelector('div');
                        circle.className = 'w-4 h-4 bg-success rounded-full flex items-center justify-center';
                        circle.innerHTML = '<svg class="h-3 w-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
                    });
                    
                    // Show success and contest info
                    setTimeout(() => {
                        progressContainer.classList.add('hidden');
                        showContestInfo();
                    }, 1000);
                } else {
                    // Update current step
                    const stepIndex = Math.floor((progress / 100) * steps.length);
                    if (stepIndex > currentStep && stepIndex < steps.length) {
                        const step = document.getElementById(steps[currentStep]);
                        const circle = step.querySelector('div');
                        circle.className = 'w-4 h-4 bg-primary rounded-full';
                        currentStep = stepIndex;
                    }
                }
                
                progressBar.style.width = progress + '%';
                progressPercentage.textContent = Math.round(progress) + '%';
            }, 200);
        }

        function showContestInfo() {
            const banner = document.getElementById('connection-banner');
            const contestInfo = document.getElementById('contest-info');
            
            banner.classList.remove('hidden');
            contestInfo.classList.remove('hidden');
            
            // Start countdown timer
            startCountdownTimer();
        }

        function startCountdownTimer() {
            const timeElement = document.getElementById('time-remaining');
            let totalSeconds = 6300; // 1h 45m in seconds
            
            const timer = setInterval(() => {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                let timeString = '';
                if (hours > 0) {
                    timeString += hours + 'h ';
                }
                timeString += minutes + 'm';
                
                timeElement.textContent = timeString;
                
                totalSeconds--;
                
                if (totalSeconds < 0) {
                    clearInterval(timer);
                    timeElement.textContent = 'Contest Ended';
                    timeElement.className = 'text-error font-medium mt-1';
                }
            }, 1000);
        }

        // Proceed to problems
        document.getElementById('proceed-btn').addEventListener('click', function() {
            const displayName = document.getElementById('display-name').value.trim();
            const nameError = document.getElementById('name-error');
            
            if (!displayName) {
                nameError.classList.remove('hidden');
                document.getElementById('display-name').focus();
                return;
            }
            
            // Store participant info and redirect
            localStorage.setItem('participantName', displayName);
            localStorage.setItem('participantEmail', document.getElementById('participant-email').value);
            localStorage.setItem('teamName', document.getElementById('team-name').value);
            
            window.location.href = 'problem_viewer.html';
        });

        // Manual WebRTC setup
        document.getElementById('process-offer-btn').addEventListener('click', function() {
            const offer = document.getElementById('manual-offer').value.trim();
            const answerSection = document.getElementById('manual-answer');
            const answerOutput = document.getElementById('answer-output');
            
            if (!offer) {
                alert('Please paste the WebRTC offer first');
                return;
            }
            
            // Simulate processing offer and generating answer
            const mockAnswer = btoa(JSON.stringify({
                type: 'answer',
                sdp: 'v=0\r\no=- ' + Date.now() + ' 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0\r\na=msid-semantic: WMS\r\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\r\nc=IN IP4 0.0.0.0\r\na=ice-ufrag:mock\r\na=ice-pwd:mockpassword\r\na=ice-options:trickle\r\na=fingerprint:sha-256 ' + Array(64).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join('').toUpperCase().match(/.{2}/g).join(':') + '\r\na=setup:active\r\na=mid:0\r\na=sctp-port:5000\r\na=max-message-size:262144\r\n'
            }));
            
            answerOutput.value = mockAnswer;
            answerSection.classList.remove('hidden');
        });

        document.getElementById('copy-answer-btn').addEventListener('click', function() {
            const answerOutput = document.getElementById('answer-output');
            answerOutput.select();
            document.execCommand('copy');
            
            this.textContent = 'Copied!';
            setTimeout(() => {
                this.textContent = 'Copy Answer';
            }, 2000);
        });

        // Auto-uppercase invite token
        document.getElementById('invite-token').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>